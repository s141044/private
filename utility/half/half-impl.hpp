
///////////////////////////////////////////////////////////////////////////////////////////////////

namespace nn{

///////////////////////////////////////////////////////////////////////////////////////////////////

namespace render{

///////////////////////////////////////////////////////////////////////////////////////////////////
//half
///////////////////////////////////////////////////////////////////////////////////////////////////

//ƒRƒ“ƒXƒgƒ‰ƒNƒ^
inline half::half(const float f)
{
	const uint32_t i = UF(f).u;
	const float abs_f = UF(i & 0x7fffffff).f;
	const uint32_t s = ((i & 0x80000000) >> 31);
	const uint32_t e = ((i & 0x7f800000) >> 23);
	const uint32_t m = ((i & 0x007fffff));

	//–³ŒÀ‘å
	if(abs_f >= 65504.0f){
		m_data = uint16_t((s << 15) | (0x1f << 10));
	}
	//ƒ[ƒ
	else if(abs_f < 5.9604644775390625e-08f){
		m_data = uint16_t(s << 15);
	}
	//”ñ³‹K‰»”
	else if(abs_f < 6.103515625e-05f){
		m_data = uint16_t((s << 15) | (((m | (1 << 23)) >> (127 - 14 - e)) >> 13));
	}
	//”ñ”
	else if((e == 0xff) && (m != 0x00)){
		m_data = uint16_t((s << 15) | (0x3f << 9));
	}
	//³‹K‰»”
	else{
		m_data = uint16_t((s << 15) | ((e - 127 + 15) << 10) | (m >> 13));
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////////

//ƒLƒƒƒXƒg‰‰Zq
inline half::operator float() const
{
	const uint32_t s = uint32_t((m_data & 0x8000) >> 15);
	const uint32_t e = uint32_t((m_data & 0x7c00) >> 10);
	const uint32_t m = uint32_t((m_data & 0x03ff));

	if(e == 0x00){

		//ƒ[ƒ
		if(m == 0x00){
			return UF(s << 31).f;
		}
		//”ñ³‹K‰»”
		else{
			return UF((s << 31) | ((-14 + 127) << 23) | (m << 13)).f
				 - UF((s << 31) | ((-14 + 127) << 23)).f;
		}
	}
	else if(e == 0x1f){

		//–³ŒÀ‘å
		if(m == 0x00){
			return UF((s << 31) | (0xff << 23)).f;
		}
		//”ñ”
		else{
			return UF((s << 31) | (0x1ff << 22)).f;
		}
	}
	//³‹K‰»”
	else{
		return UF((s << 31) | ((e - 15 + 127) << 23) | (m << 13)).f;
	}
}

///////////////////////////////////////////////////////////////////////////////////////////////////

} //namespace render

///////////////////////////////////////////////////////////////////////////////////////////////////

} //namespace nn

///////////////////////////////////////////////////////////////////////////////////////////////////
